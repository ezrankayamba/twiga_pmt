{% extends "core/base.html" %} {% load humanize %} {% load crispy_forms_tags %}
{% block content %}
<style type="text/css">
    form .input-group-text {
        min-width: 6rem;
    }
    form {
        font-size: .50rem;
    }
    @media screen and (min-width: 30rem) {
        form input[name='name'].textinput{
            min-width: 24.5rem;
        }
        form .select {
            max-width: 9rem;
            min-width: 9rem;
        }
    }
</style>
<div class="row pb-2">
    <div class="col-md">
        <h5>List of projects({{total_projects}})</h5>
    </div>
    <div class="col-md">
        <div class="button-group float-md-right">
            <a href="#" class="btn btn-sm btn-outline-secondary"
                ><i class="fa fa-file-excel"></i> Import</a
            >
            <a
                href="{% url 'projects-export' %}"
                class="btn btn-sm btn-outline-primary"
                ><i class="fa fa-file-excel"></i> Export</a
            >
            <a
                class="btn btn-primary btn-sm "
                href="{% url 'projects-create' %}"
                ><i class="fa fa-plus"></i> New Project</a
            >
        </div>
    </div>
</div>
<div class="row small">
    <div class="col">
        <form method="post" class="mb-2 bg-light pl-2 pr-2 pb-2 pt-0">
            {% csrf_token %}
            <div class="container">
                <div class="row align-items-end">
                    <div class="col-md form-inline p-0" id="filter-form">
                        {{ filter.form|crispy }}
                    </div>
                    <div>
                        <button
                            type="submit"
                            class="btn btn-sm btn-outline-info mt-2 float-right"
                        >
                            <a class="fa fa-filter d-block"></a> Search
                        </button>
                    </div>
                </div>
            </div>
        </form>
        <div class="table-responsive-sm x-scrolling small">
            <table class="table table-sm table-hover table-bordered">
                <thead class="bg-light">
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Name</th>
                        <th scope="col">Location</th>
                        <th scope="col">Type</th>
                        <th scope="col">Size</th>
                        <th scope="col">StartDate</th>
                        <th scope="col">Authority</th>
                        <th scope="col">Contractors</th>
                        <th scope="col">Consultants</th>
                        <th scope="col">Status</th>
                        <th scope="col">
                            <span class="nowrap">Duration</span>
                        </th>
                        <th scope="col">Financers</th>
                        <th scope="col">
                            <span class="nowrap">Quantity</span>
                        </th>
                        <th scope="col">
                            <span class="nowrap">Supplied</span>
                        </th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                {% for prj in page_obj %}
                <tr>
                    <td scope="row">{{prj.id}}</td>
                    <td>{{prj.name}}</td>
                    <td>{{prj.get_location}}</td>
                    <td>{{prj.type}}</td>
                    <td>{{prj.size}}</td>
                    <td>{{prj.start_date}}</td>
                    <td>{{prj.authority}}</td>
                    <td>
                        {%for c in prj.contractors.all %}
                        <p class="text-muted mb-0">
                            <i class="fa fa-check text-muted"></i>
                            {{c.contractor.name}}
                        </p>
                        {%empty%}
                        <span class="text-warning">Not set</span>
                        {%endfor%}
                    </td>
                    <td>
                        {%for c in prj.consultants.all %}
                        <p class="text-muted mb-0">
                            <i class="fa fa-check text-muted"></i>
                            {{c.consultant.name}}
                        </p>
                        {%empty%}
                        <span class="text-warning">Not set</span>
                        {%endfor%}
                    </td>
                    <td>{{prj.status}}</td>
                    <td>{{prj.duration }} Years</td>
                    <td>
                        {%for f in prj.financers.all %}
                        <p class="text-muted mb-0">
                            <i class="fa fa-check text-muted"></i>
                            {{f.financer.name}}
                        </p>
                        {%empty%}<span class="text-warning">Not set</span>
                        {%endfor%}
                    </td>
                    <td>{{prj.quantity_demanded|floatformat:0 }} Tons</td>
                    <td>{{prj.quantity_supplied|floatformat:0 }} Tons</td>
                    <td>
                        <a
                            role="button"
                            class="btn btn-link btn-sm p-0"
                            href="{% url 'projects-detail' prj.id %}"
                            ><i class="fa fa-eye"></i
                        ></a>
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
    {% for prj in projects %} {% endfor %}
</div>
<div class="row">
    <div class="col">
        <form method="POST">
            {% csrf_token %}
            {% if is_paginated %}
              <div class="btn-group" role="group" aria-label="Basic example">
                  {% if page_obj.has_previous %}
                    <button name="page" class="btn btn-sm btn-outline-info" value="1">First</a>
                    <button name="page" class="btn btn-sm btn-outline-info" value="{{ page_obj.previous_page_number }}">Previous</a>
                  {% endif %}

                  {% for num in page_obj.paginator.page_range %}
                      {% if page_obj.number == num %}
                        <button name="page" class="btn btn-sm btn-info" value="{{ num }}">{{ num }}</a>
                      {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <button name="page" class="btn btn-sm btn-outline-info" value="{{ num }}">{{ num }}</a>
                      {% endif %}
                  {% endfor %}

                  {% if page_obj.has_next %}
                    <button name="page" class="btn btn-sm btn-outline-info" value="{{ page_obj.next_page_number }}">Next</a>
                    <button name="page" class="btn btn-sm btn-outline-info" value="{{page_obj.paginator.num_pages }}">Last</a>
                  {% endif %}
              </div>
              <div class="d-none">
                 {{ filter.form|crispy }}
              </div>
            {% endif %}

        </form>
    </div>
</div>
<script type="text/javascript">
    (function() {
        let getEl = (selector, prnt) => {
            return prnt.querySelector(selector);
        };
        let addCls = (el, cls) => {
            cls.split(" ").forEach(cl => {
                el.classList.add(cl);
            });
        };
        let form = document.querySelector("#filter-form");
        form.querySelectorAll(".form-group").forEach(grp => {
            addCls(grp, "input-group input-group-sm mr-2 mt-2");
            let label = getEl("label", grp);
            let div = document.createElement("div");
            let span = document.createElement("span");
            addCls(div, "input-group-prepend");
            addCls(span, "input-group-text");
            span.textContent = label.textContent;
            grp.removeChild(label);
            div.appendChild(span);
            let inputDiv = getEl("div", grp);
            let crtr = getEl(".form-control", inputDiv);
            grp.removeChild(inputDiv);
            grp.appendChild(div);
            grp.appendChild(crtr);
        });
    })();
</script>
{% endblock content%}
